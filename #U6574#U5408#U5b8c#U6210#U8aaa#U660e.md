# Supabase èˆ‡ Stripe æ•´åˆå®Œæˆèªªæ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç’°å¢ƒé…ç½®
- âœ… å‰µå»º `.env` æ–‡ä»¶ï¼ŒåŒ…å«æ‚¨æä¾›çš„ Supabase å’Œ Stripe æ†‘è­‰
- âœ… é…ç½®æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šé‡

### 2. Supabase æ•´åˆ
- âœ… é…ç½® Supabase å®¢æˆ¶ç«¯ (`lib/supabase.ts`)
- âœ… å¯¦ç¾å®Œæ•´çš„èº«ä»½é©—è­‰ç³»çµ± (`providers/AuthProvider.tsx`)
  - ç”¨æˆ¶è¨»å†Š
  - ç”¨æˆ¶ç™»å…¥
  - ç”¨æˆ¶ç™»å‡º
  - å¯†ç¢¼é‡ç½®
  - å€‹äººè³‡æ–™ç®¡ç†
  - æœƒå“¡ç­‰ç´šæª¢æŸ¥
- âœ… å‰µå»ºç™»å…¥å’Œè¨»å†Šç•Œé¢
  - `app/auth/sign-in.tsx` - ç™»å…¥é é¢
  - `app/auth/sign-up.tsx` - è¨»å†Šé é¢

### 3. Stripe æ•´åˆ
- âœ… é…ç½® Stripe Provider (`providers/StripeProvider.tsx`)
  - å‰µå»ºè¨‚é–±æœƒè©±
  - å–æ¶ˆè¨‚é–±
  - æœƒå“¡æ–¹æ¡ˆç®¡ç†
- âœ… å‰µå»ºå¾Œç«¯ API è·¯ç”±
  - `backend/trpc/routes/stripe/create-checkout-session/route.ts` - å‰µå»ºæ”¯ä»˜æœƒè©±
  - `backend/trpc/routes/stripe/cancel-subscription/route.ts` - å–æ¶ˆè¨‚é–±
  - `backend/trpc/routes/stripe/webhook/route.ts` - è™•ç† Stripe Webhook
- âœ… æ›´æ–° tRPC è·¯ç”±å™¨ä»¥åŒ…å« Stripe ç«¯é»
- âœ… å‰µå»ºè¨‚é–±é é¢ (`app/subscription/index.tsx`)
  - é¡¯ç¤ºæœƒå“¡æ–¹æ¡ˆ
  - æœˆä»˜/å¹´ä»˜åˆ‡æ›
  - ç•¶å‰è¨‚é–±ç‹€æ…‹
  - å–æ¶ˆè¨‚é–±åŠŸèƒ½

### 4. æœƒå“¡æ–¹æ¡ˆ
å·²é…ç½®å››å€‹æœƒå“¡æ–¹æ¡ˆï¼š
- **Premium æœˆä»˜** - $9.99/æœˆ
- **Premium å¹´ä»˜** - $99.99/å¹´ï¼ˆç¯€çœ 17%ï¼‰
- **Pro æœˆä»˜** - $19.99/æœˆ
- **Pro å¹´ä»˜** - $199.99/å¹´ï¼ˆç¯€çœ 17%ï¼‰

## ğŸ“‹ éœ€è¦å®Œæˆçš„æ­¥é©Ÿ

### 1. åœ¨ Supabase ä¸­å‰µå»ºæ•¸æ“šè¡¨

æ‚¨éœ€è¦åœ¨ Supabase é …ç›®ä¸­åŸ·è¡Œä»¥ä¸‹ SQL å‘½ä»¤ä¾†å‰µå»ºå¿…è¦çš„æ•¸æ“šè¡¨ï¼š

#### A. ç”¨æˆ¶è³‡æ–™è¡¨ (profiles)
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  membership_tier TEXT DEFAULT 'free' CHECK (membership_tier IN ('free', 'premium', 'pro')),
  membership_expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);
```

#### B. æ›¸ç±¤è¡¨ (bookmarks)
```sql
CREATE TABLE bookmarks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  title TEXT NOT NULL,
  url TEXT NOT NULL,
  favicon TEXT,
  favorite BOOLEAN DEFAULT false,
  folder_id UUID REFERENCES folders(id) ON DELETE SET NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own bookmarks"
  ON bookmarks FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own bookmarks"
  ON bookmarks FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own bookmarks"
  ON bookmarks FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own bookmarks"
  ON bookmarks FOR DELETE
  USING (auth.uid() = user_id);
```

#### C. æ–‡ä»¶å¤¾è¡¨ (folders)
```sql
CREATE TABLE folders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  icon TEXT DEFAULT 'ğŸ“',
  category_id TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE folders ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own folders"
  ON folders FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own folders"
  ON folders FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own folders"
  ON folders FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own folders"
  ON folders FOR DELETE
  USING (auth.uid() = user_id);
```

#### D. è‡ªå‹•å‰µå»ºç”¨æˆ¶è³‡æ–™
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'full_name'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

### 2. åœ¨ Stripe ä¸­å‰µå»ºç”¢å“å’Œåƒ¹æ ¼

1. å‰å¾€ [Stripe Dashboard](https://dashboard.stripe.com/test/products)
2. å‰µå»º 4 å€‹ç”¢å“ï¼š
   - Premium Monthly - $9.99/æœˆ
   - Premium Yearly - $99.99/å¹´
   - Pro Monthly - $19.99/æœˆ
   - Pro Yearly - $199.99/å¹´

3. è¤‡è£½æ¯å€‹ç”¢å“çš„ **Price ID**ï¼ˆä»¥ `price_` é–‹é ­ï¼‰

4. æ›´æ–° `.env` æ–‡ä»¶ä¸­çš„ Price IDï¼š
```env
EXPO_PUBLIC_STRIPE_PREMIUM_MONTHLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_PREMIUM_YEARLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID=price_xxxxxxxxxxxxx
```

### 3. è¨­ç½® Stripe Webhook

1. å‰å¾€ [Stripe Webhooks](https://dashboard.stripe.com/test/webhooks)
2. é»æ“Š "Add endpoint"
3. è¼¸å…¥æ‚¨çš„ webhook URLï¼š`https://your-domain.com/api/trpc/stripe.webhook`
4. é¸æ“‡ä»¥ä¸‹äº‹ä»¶ï¼š
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`

## ğŸ§ª æ¸¬è©¦æµç¨‹

### æ¸¬è©¦èº«ä»½é©—è­‰
1. å•Ÿå‹•æ‡‰ç”¨ï¼š`npm start`
2. å°èˆªåˆ°è¨»å†Šé é¢
3. å‰µå»ºæ–°å¸³æˆ¶
4. é©—è­‰ Supabase ä¸­æ˜¯å¦å‰µå»ºäº†ç”¨æˆ¶è³‡æ–™

### æ¸¬è©¦è¨‚é–±
1. ç™»å…¥æ‚¨çš„å¸³æˆ¶
2. å°èˆªåˆ° `/subscription`
3. é¸æ“‡ä¸€å€‹æ–¹æ¡ˆ
4. å®Œæˆçµå¸³ï¼ˆä½¿ç”¨æ¸¬è©¦å¡è™Ÿï¼š`4242 4242 4242 4242`ï¼‰
5. é©—è­‰ Supabase ä¸­çš„æœƒå“¡ç­‰ç´šæ˜¯å¦æ›´æ–°

## ğŸ“ é …ç›®çµæ§‹

```
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ sign-in.tsx          # ç™»å…¥é é¢
â”‚   â”‚   â””â”€â”€ sign-up.tsx          # è¨»å†Šé é¢
â”‚   â””â”€â”€ subscription/
â”‚       â””â”€â”€ index.tsx            # è¨‚é–±é é¢
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ trpc/
â”‚       â””â”€â”€ routes/
â”‚           â””â”€â”€ stripe/          # Stripe API è·¯ç”±
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ AuthProvider.tsx         # èº«ä»½é©—è­‰æä¾›è€…
â”‚   â””â”€â”€ StripeProvider.tsx       # Stripe æä¾›è€…
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ supabase.ts             # Supabase å®¢æˆ¶ç«¯é…ç½®
â””â”€â”€ .env                        # ç’°å¢ƒè®Šé‡ï¼ˆå·²é…ç½®ï¼‰
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é …

1. âœ… æ‰€æœ‰æ•æ„Ÿå¯†é‘°å·²æ­£ç¢ºé…ç½®åœ¨ `.env` æ–‡ä»¶ä¸­
2. âœ… Supabase ä½¿ç”¨ Row Level Security (RLS) ä¿è­·æ•¸æ“š
3. âœ… Stripe å¯†é‘°åƒ…åœ¨æœå‹™å™¨ç«¯ä½¿ç”¨
4. âš ï¸ è«‹å‹¿å°‡ `.env` æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»çµ±

## ğŸ“š ç›¸é—œæ–‡æª”

è©³ç´°çš„è¨­ç½®èªªæ˜è«‹åƒé–±ï¼š`SUPABASE_STRIPE_SETUP.md`

## âœ… ä¸‹ä¸€æ­¥

1. åœ¨ Supabase ä¸­åŸ·è¡Œ SQL å‘½ä»¤å‰µå»ºæ•¸æ“šè¡¨
2. åœ¨ Stripe Dashboard ä¸­å‰µå»ºç”¢å“å’Œåƒ¹æ ¼
3. æ›´æ–° `.env` æ–‡ä»¶ä¸­çš„ Price ID
4. è¨­ç½® Stripe Webhook
5. æ¸¬è©¦å®Œæ•´æµç¨‹
6. éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ

## ğŸ‰ å®Œæˆï¼

æ‚¨çš„æ‡‰ç”¨ç¾åœ¨å·²ç¶“å®Œå…¨æ•´åˆäº† Supabase å’Œ Stripeï¼ç”¨æˆ¶å¯ä»¥ï¼š
- âœ… è¨»å†Šå’Œç™»å…¥
- âœ… ç®¡ç†å€‹äººè³‡æ–™
- âœ… è¨‚é–±æœƒå“¡æ–¹æ¡ˆ
- âœ… ç®¡ç†è¨‚é–±
- âœ… å­˜å„²å’ŒåŒæ­¥æ•¸æ“š

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒé–± `SUPABASE_STRIPE_SETUP.md` ä¸­çš„æ•…éšœæ’é™¤éƒ¨åˆ†ã€‚
