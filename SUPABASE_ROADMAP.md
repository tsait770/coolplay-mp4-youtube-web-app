# 🗺️ Supabase 資料庫優化 - 完整執行路線圖

**目標**: 從當前狀態到完全驗證完成  
**總預計時間**: 5-10 分鐘  
**難度**: ⭐⭐☆☆☆ (簡單)

---

## 🎯 你現在在哪裡？

根據你的截圖分析：

```
┌─────────────────────────────────────────────────────┐
│  當前狀態 (截圖顯示)                                 │
├─────────────────────────────────────────────────────┤
│  ✅ SQL 代碼已載入到 SQL Editor                      │
│  ⏳ SQL 尚未執行 (等待點擊 Run)                      │
│  ⏳ 資料表狀態未確認 (需驗證)                        │
│  ❓ RLS 策略未確認                                   │
│  ❓ 函式未確認                                       │
└─────────────────────────────────────────────────────┘

進度: ▓▓░░░░░░░░ 20% (SQL 已載入)
```

---

## 🚀 完整執行路線圖

### 階段 1: 執行 SQL Schema ⏰ 2 分鐘

```
起點: SQL Editor (你的截圖 1)
目標: 建立資料表、函式、RLS 策略

┌─────────────────────────────────────────────────────┐
│  步驟 1.1: 確認 SQL 代碼完整                         │
│  ─────────────────────────────────────────────────  │
│  • 捲動檢查是否有完整的 307 行                       │
│  • 確認最後包含 GRANT 權限語句                       │
│  • 確認沒有被截斷或缺失                              │
│                                                     │
│  步驟 1.2: 執行 SQL                                  │
│  ─────────────────────────────────────────────────  │
│  • 點擊右下角綠色 "Run" 按鈕                         │
│  • 或按快捷鍵 ⌘ + Enter (Mac) / Ctrl + Enter (Win)  │
│  • 等待 2-5 秒執行完成                               │
│                                                     │
│  步驟 1.3: 確認執行成功                              │
│  ─────────────────────────────────────────────────  │
│  ✅ 正確: "Success. No rows returned"               │
│  ❌ 錯誤: 查看錯誤訊息 → 跳到「問題診斷」           │
└─────────────────────────────────────────────────────┘

進度: ▓▓▓▓░░░░░░ 40% (SQL 已執行)
```

**檢查點**: SQL Editor 底部顯示 "Success. No rows returned"

---

### 階段 2: Dashboard 手動驗證 ⏰ 3 分鐘

```
起點: SQL 執行成功
目標: 確認資料表、函式、RLS 策略存在

┌─────────────────────────────────────────────────────┐
│  步驟 2.1: 檢查資料表 (1 分鐘)                       │
│  ─────────────────────────────────────────────────  │
│  路徑: Database → Tables                            │
│  動作:                                              │
│    1. 在左側 Tables 清單搜尋 "voice"                │
│    2. 確認以下 3 個資料表存在:                       │
│       ✅ voice_usage_logs                           │
│       ✅ voice_control_settings                     │
│       ✅ voice_quota_usage                          │
│    3. 點擊任一資料表查看欄位結構                     │
│                                                     │
│  步驟 2.2: 檢查函式 (1 分鐘)                         │
│  ─────────────────────────────────────────────────  │
│  路徑: Database → Functions                         │
│  動作:                                              │
│    1. 搜尋 "voice" 或直接瀏覽清單                   │
│    2. 確認以下 4 個函式存在:                         │
│       ✅ get_voice_quota_usage                      │
│       ✅ increment_voice_quota                      │
│       ✅ create_default_voice_settings              │
│       ✅ update_updated_at_column                   │
│                                                     │
│  步驟 2.3: 檢查 RLS 策略 (1 分鐘)                    │
│  ─────────────────────────────────────────────────  │
│  路徑: Database → Tables → [選擇資料表] → RLS 標籤   │
│  動作:                                              │
│    1. 點擊 voice_usage_logs                         │
│    2. 切換到 "RLS" 標籤                             │
│    3. 確認顯示 "RLS enabled" (綠色)                 │
│    4. 確認有 2 條策略 (SELECT, INSERT)              │
│    5. 重複檢查其他 2 個語音資料表                    │
└─────────────────────────────────────────────────────┘

進度: ▓▓▓▓▓▓▓░░░ 70% (手動驗證完成)
```

**檢查點**: 3 個資料表 + 4 個函式都存在，RLS 顯示 enabled

---

### 階段 3: 自動化驗證 ⏰ 2 分鐘

```
起點: Dashboard 手動驗證通過
目標: 通過自動化測試確認一切正常

┌─────────────────────────────────────────────────────┐
│  步驟 3.1: 執行驗證腳本                              │
│  ─────────────────────────────────────────────────  │
│  開啟終端機，切換到專案根目錄:                       │
│                                                     │
│  $ cd /path/to/your/project                         │
│  $ bun scripts/verify-supabase-database.ts          │
│                                                     │
│  或使用一鍵腳本:                                     │
│                                                     │
│  # macOS / Linux                                    │
│  $ chmod +x verify-supabase.sh                      │
│  $ ./verify-supabase.sh                             │
│                                                     │
│  # Windows                                          │
│  > verify-supabase.bat                              │
│                                                     │
│  步驟 3.2: 查看驗證結果                              │
│  ─────────────────────────────────────────────────  │
│  ✅ 正確輸出:                                        │
│     ✅ 連接成功                                      │
│     ✅ 所有資料表可存取                              │
│     ✅ RLS 策略正常                                  │
│     ✅ 資料庫結構完整，可以開始使用！                │
│                                                     │
│  ❌ 錯誤輸出:                                        │
│     查看錯誤訊息 → 跳到「問題診斷」                  │
└─────────────────────────────────────────────────────┘

進度: ▓▓▓▓▓▓▓▓▓░ 90% (自動化驗證完成)
```

**檢查點**: 終端機顯示 "✅ 資料庫結構完整，可以開始使用！"

---

### 階段 4: 應用程式整合測試 ⏰ 5 分鐘 (可選)

```
起點: 自動化驗證通過
目標: 在實際應用程式中測試功能

┌─────────────────────────────────────────────────────┐
│  步驟 4.1: 啟動開發伺服器                            │
│  ─────────────────────────────────────────────────  │
│  $ bun start                                        │
│  或                                                 │
│  $ npx expo start                                   │
│                                                     │
│  步驟 4.2: 測試新用戶註冊                            │
│  ─────────────────────────────────────────────────  │
│  動作:                                              │
│    1. 在 App 中註冊一個新用戶                        │
│    2. 前往 Supabase Dashboard → Database → Tables   │
│    3. 查看 voice_control_settings 資料表            │
│    4. 確認自動建立了一筆該用戶的設定記錄             │
│                                                     │
│  步驟 4.3: 測試語音指令記錄                          │
│  ─────────────────────────────────────────────────  │
│  動作:                                              │
│    1. 執行一次語音指令 (如 "播放")                   │
│    2. 檢查 voice_usage_logs 資料表                  │
│    3. 確認有新記錄插入                               │
│                                                     │
│  步驟 4.4: 測試配額查詢                              │
│  ─────────────────────────────────────────────────  │
│  動作:                                              │
│    1. 在 App 中查看語音配額 (如有 UI)                │
│    2. 或在 SQL Editor 執行:                         │
│       SELECT * FROM get_voice_quota_usage(          │
│         'user-uuid'::uuid, 'daily'                  │
│       );                                            │
│    3. 確認回傳正確的配額資訊                         │
└─────────────────────────────────────────────────────┘

進度: ▓▓▓▓▓▓▓▓▓▓ 100% (完全驗證完成)
```

**檢查點**: 應用程式可正常使用語音控制功能

---

## 🔀 問題診斷決策樹

```
                 執行 SQL
                    │
                    ▼
         ┌──────────────────┐
         │ 顯示 "Success"？  │
         └──────────────────┘
              │         │
           是 │         │ 否
              │         │
              ▼         ▼
         [繼續階段2]  ┌─────────────────┐
                     │ 錯誤類型？        │
                     └─────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
   "already        "permission       "syntax
    exists"          denied"           error"
         │                │                │
         ▼                ▼                ▼
   [檢查是否       [檢查用戶       [重新複製
   已建立]          權限]          SQL 代碼]
         │                │                │
         └────────────────┴────────────────┘
                          │
                          ▼
                   [參考故障排除]


                 階段 2 驗證
                    │
                    ▼
         ┌──────────────────┐
         │ 資料表存在？      │
         └──────────────────┘
              │         │
           是 │         │ 否
              │         │
              ▼         ▼
         [繼續階段3]  [重新執行SQL]
                          │
                          ▼
                   [檢查錯誤訊息]


                 階段 3 驗證
                    │
                    ▼
         ┌──────────────────┐
         │ 全部通過？        │
         └──────────────────┘
              │         │
           是 │         │ 否
              │         │
              ▼         ▼
         [完成!]    ┌─────────────────┐
                    │ 失敗類型？        │
                    └─────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
   "連接失敗"     "資料表不存在"    "RLS 失敗"
        │                │                │
        ▼                ▼                ▼
   [檢查 .env]     [重新執行SQL]   [檢查 RLS 設定]
```

---

## 📊 進度追蹤表

複製以下表格到你的筆記中，逐項勾選：

```
┌─────────────────────────────────────────────────────┐
│  階段 1: 執行 SQL Schema                             │
├─────────────────────────────────────────────────────┤
│  [ ] 1.1 確認 SQL 代碼完整                           │
│  [ ] 1.2 點擊 Run 執行 SQL                           │
│  [ ] 1.3 確認顯示 "Success"                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  階段 2: Dashboard 手動驗證                          │
├─────────────────────────────────────────────────────┤
│  [ ] 2.1 確認 voice_usage_logs 存在                  │
│  [ ] 2.2 確認 voice_control_settings 存在            │
│  [ ] 2.3 確認 voice_quota_usage 存在                 │
│  [ ] 2.4 確認 4 個函式存在                           │
│  [ ] 2.5 確認 RLS 在 3 個資料表上為 enabled          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  階段 3: 自動化驗證                                  │
├─────────────────────────────────────────────────────┤
│  [ ] 3.1 執行 verify-supabase-database.ts            │
│  [ ] 3.2 確認連接成功                                │
│  [ ] 3.3 確認所有資料表可存取                        │
│  [ ] 3.4 確認 RLS 策略正常                           │
│  [ ] 3.5 顯示 "資料庫結構完整"                       │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  階段 4: 應用程式整合測試 (可選)                     │
├─────────────────────────────────────────────────────┤
│  [ ] 4.1 新用戶註冊測試                              │
│  [ ] 4.2 語音指令記錄測試                            │
│  [ ] 4.3 配額查詢測試                                │
└─────────────────────────────────────────────────────┘

✅ 全部完成！可以開始開發了！
```

---

## 🎯 快速命令參考

### Supabase Dashboard 快速連結

```bash
# 專案首頁
https://supabase.com/dashboard/project/ukpskaspdzinzpsdoodi

# SQL Editor (執行 SQL)
https://supabase.com/dashboard/project/ukpskaspdzinzpsdoodi/sql/new

# Tables (檢查資料表)
https://supabase.com/dashboard/project/ukpskaspdzinzpsdoodi/editor

# Functions (檢查函式)
https://supabase.com/dashboard/project/ukpskaspdzinzpsdoodi/database/functions

# RLS Policies (檢查安全策略)
https://supabase.com/dashboard/project/ukpskaspdzinzpsdoodi/auth/policies
```

---

### 終端機命令

```bash
# 快速驗證 (推薦)
./verify-supabase.sh              # macOS/Linux
verify-supabase.bat               # Windows

# 手動驗證
bun scripts/verify-supabase-database.ts

# 完整測試
bun scripts/run-supabase-tests.ts

# 查看環境變數
cat .env | grep SUPABASE

# 啟動開發伺服器
bun start
```

---

## 📚 相關文件快速索引

```
┌─────────────────────────────────────────────────────┐
│  需求                     │  文件                    │
├──────────────────────────┼─────────────────────────┤
│  快速開始                 │  SUPABASE_QUICK_REFERENCE.md        │
│  詳細流程                 │  SUPABASE_VERIFICATION_SOP.md       │
│  技術細節                 │  SUPABASE_DATABASE_OPTIMIZATION_REPORT.md │
│  任務完成度               │  SUPABASE_TASK_COMPLETION_REPORT.md │
│  截圖分析                 │  SUPABASE_SCREENSHOT_ANALYSIS.md    │
│  文件索引                 │  SUPABASE_DOCUMENTS_INDEX.md        │
│  執行總結                 │  SUPABASE_EXECUTION_SUMMARY.md      │
│  路線圖 (本文件)          │  SUPABASE_ROADMAP.md                │
└─────────────────────────────────────────────────────┘
```

---

## 🎉 成功標誌

當你看到以下所有標誌時，表示完全成功：

```
✅ SQL Editor 顯示 "Success"
✅ Tables 清單包含 3 個 voice 資料表
✅ Functions 清單包含 4 個函式
✅ RLS 在所有語音資料表上為 enabled
✅ 驗證腳本全部顯示 ✅
✅ 應用程式可正常使用語音功能 (如已整合)
```

**恭喜！你已完成 Supabase 資料庫優化與驗證！** 🎊

---

## 🚀 立即開始

**推薦路徑** (最快 5 分鐘):

1. 點擊 SQL Editor 的 **Run** 按鈕
2. 執行 `./verify-supabase.sh`
3. 查看結果

**或者查看**:
- `SUPABASE_QUICK_REFERENCE.md` (快速參考)
- `SUPABASE_SCREENSHOT_ANALYSIS.md` (你的當前狀態分析)

**祝你成功！** 🎯

---

**路線圖版本**: 1.0  
**最後更新**: 2025-11-21  
**製作者**: AI 代理 (Rork)
